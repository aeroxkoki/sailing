# セーリング戦略分析システム - モジュール分析レポート

## 1. 既存システムの分析

### 1.1 システム概要

現在のセーリング戦略分析システムは、Streamlit/Pythonベースのプロトタイプとして実装されています。主な目的は、GPSデータを活用して風向風速を推定し、セーリング競技者の意思決定を客観的に評価することです。

### 1.2 主要コンポーネントと責務

既存システムは以下の主要なコンポーネントで構成されています：

1. **SailingDataProcessor (core.py)**: システムの中核となるクラス
   - GPSデータの読み込み、前処理
   - 複数艇のデータ同期
   - 風向風速推定の統合管理
   - データ管理とパフォーマンス最適化

2. **WindEstimator (wind_estimator.py)**: 風向風速推定の専門クラス
   - 単一艇からの風向風速推定
   - マニューバー（タック/ジャイブ）検出
   - VMG解析、コース/速度分析
   - 複数の推定手法の統合（ベイズ推定）

3. **UI関連モジュール (ui/以下)**: Streamlitベースのインターフェース
   - 地図表示、データ可視化
   - インタラクティブな操作
   - 分析結果の表示

### 1.3 現在のコード構造の課題

1. **モジュール間の高い結合度**:
   - CoreモジュールがUI、データ処理、分析など多くの責務を持つ
   - 明確なレイヤー分けがされていない

2. **APIの欠如**:
   - 外部からの呼び出しを考慮したAPIデザインになっていない
   - データのやり取りがメモリ内のオブジェクト参照に依存している

3. **データ永続化の限界**:
   - ローカルストレージ（IndexedDB）に依存
   - マルチユーザー対応が困難

4. **ユーザー認証・権限管理機能の欠如**:
   - ユーザー管理の仕組みがない
   - データの所有権やアクセス制御の仕組みがない

## 2. 新アーキテクチャのモジュール設計

### 2.1 バックエンド (FastAPI)

#### 2.1.1 APIレイヤー
- **認証API**
  - ユーザー登録、ログイン、トークン管理
  - Supabaseの認証機能を活用

- **セッションAPI**
  - セッション作成、取得、更新、削除
  - セッション内データのCRUD操作

- **分析API**
  - 風向風速推定
  - 戦略ポイント検出
  - 統計分析

- **データエクスポート/インポートAPI**
  - GPXファイルのインポート
  - CSVエクスポート
  - 共有機能

#### 2.1.2 サービスレイヤー
- **風推定サービス**
  - WindEstimatorコアロジックの再実装
  - バッチ処理とキャッシング最適化

- **セッション管理サービス**
  - セッションデータの永続化
  - セッション間の比較機能

- **ユーザー管理サービス**
  - ユーザー設定の管理
  - チーム・グループ管理

#### 2.1.3 データモデル
- **ユーザーモデル**
  - ユーザー情報、設定、プリファレンス

- **セッションモデル**
  - メタデータ
  - GPS軌跡データ
  - 風推定結果

- **分析結果モデル**
  - 戦略ポイント
  - パフォーマンス指標
  - 統計データ

### 2.2 フロントエンド (Next.js)

#### 2.2.1 ページコンポーネント
- **ダッシュボード**
  - 最新セッション一覧
  - 統計情報サマリー

- **セッション詳細**
  - マップビュー
  - タイムライン
  - 分析パネル

- **セッション管理**
  - セッションリスト
  - インポート/エクスポート

- **ユーザー管理**
  - プロフィール設定
  - チーム設定

#### 2.2.2 共通コンポーネント
- **マップコンポーネント**
  - GPS軌跡表示
  - 風向風速レイヤー
  - 戦略ポイントマーカー

- **グラフ・チャートコンポーネント**
  - 速度プロファイル
  - 風向風速トレンド
  - VMG分析グラフ

- **タイムラインコンポーネント**
  - 時間操作UI
  - イベントマーカー

#### 2.2.3 状態管理
- **グローバル状態**
  - ユーザー認証情報
  - アプリ設定

- **セッション状態**
  - 現在のセッションデータ
  - 表示設定

- **分析状態**
  - 分析結果キャッシュ
  - フィルター設定

## 3. APIエンドポイント設計案

### 3.1 認証API
- `POST /api/auth/register` - ユーザー登録
- `POST /api/auth/login` - ログイン
- `POST /api/auth/logout` - ログアウト
- `GET /api/auth/user` - 現在のユーザー情報取得

### 3.2 セッションAPI
- `GET /api/sessions` - セッション一覧取得
- `POST /api/sessions` - 新規セッション作成
- `GET /api/sessions/{id}` - 特定セッション取得
- `PUT /api/sessions/{id}` - セッション更新
- `DELETE /api/sessions/{id}` - セッション削除
- `POST /api/sessions/{id}/import` - GPXデータインポート
- `GET /api/sessions/{id}/export` - データエクスポート

### 3.3 分析API
- `GET /api/sessions/{id}/wind` - 風向風速推定結果取得
- `POST /api/sessions/{id}/wind/estimate` - 風向風速推定実行
- `GET /api/sessions/{id}/strategy-points` - 戦略ポイント取得
- `POST /api/sessions/{id}/strategy-points/detect` - 戦略ポイント検出実行
- `GET /api/sessions/{id}/statistics` - セッション統計情報取得

### 3.4 データエンティティ

#### セッションエンティティ
```json
{
  "id": "uuid",
  "user_id": "uuid",
  "name": "string",
  "created_at": "datetime",
  "updated_at": "datetime",
  "metadata": {
    "location": "string",
    "boat_type": "string",
    "weather_conditions": "string"
  },
  "tracks": [
    {
      "boat_id": "string",
      "boat_name": "string",
      "color": "string"
    }
  ]
}
```

#### トラックポイントエンティティ
```json
{
  "id": "uuid",
  "session_id": "uuid",
  "boat_id": "string",
  "timestamp": "datetime",
  "latitude": "float",
  "longitude": "float",
  "speed": "float",
  "course": "float",
  "wind_direction": "float",
  "wind_speed": "float",
  "wind_confidence": "float"
}
```

#### 戦略ポイントエンティティ
```json
{
  "id": "uuid",
  "session_id": "uuid",
  "boat_id": "string",
  "timestamp": "datetime",
  "latitude": "float",
  "longitude": "float",
  "type": "string", // "tack", "jibe", "layline", "wind_shift" etc.
  "metadata": "json",
  "importance": "float"
}
```

## 4. 移行戦略

### 4.1 コアロジックの移行

#### 風向風速推定モジュール

風向風速推定モジュールは非常に最適化されており、主要なアルゴリズムは維持すべきです。しかし、APIとしての再実装が必要です。

**変更点：**
- クラス設計を見直し、外部からのAPI呼び出しに適した形に再構成
- 状態管理の見直し（クラス変数への依存度を下げる）
- メモリ最適化戦略の更新（バックエンドに適した方法に変更）
- 非同期処理のサポート（FastAPIの特徴を活かす）

#### データ処理モジュール

データ処理モジュールは、バックエンドサービスとしての役割に適した形に再構成する必要があります。

**変更点：**
- ファイルのアップロード/ダウンロード処理をHTTPリクエスト/レスポンスに適合させる
- メモリ内データ管理からデータベース永続化へ移行
- バッチ処理とキューイングの導入（大規模データ処理用）

### 4.2 UIコンポーネントの移行

Streamlit UIから React/Next.js UIへの移行は完全な書き換えが必要ですが、既存のUI構造とワークフローは参考にできます。

**移行戦略：**
1. 現在のUIコンポーネント（mapbox地図、グラフなど）に対応するReactコンポーネントの選定
2. ユーザーフローの維持とエクスペリエンスの向上
3. レスポンシブデザインの実装
4. APIとの連携（データフェッチング、キャッシング）

### 4.3 データベース設計

Supabase/PostgreSQLを使用して、以下のテーブル構造を実装します：

- `users` - ユーザー情報
- `sessions` - セッションメタデータ
- `tracks` - 船のトラック情報
- `track_points` - GPSポイントデータ
- `wind_estimates` - 風向風速推定結果
- `strategy_points` - 戦略的判断ポイント
- `statistics` - 統計情報

地理空間データの処理には、PostgreSQLのPostGIS拡張を活用します。

## 5. 課題と対応策

### 5.1 パフォーマンス最適化

**課題:**
- 大量のGPSデータを効率的に処理する必要がある
- リアルタイム分析のレスポンス時間を短縮する

**対応策:**
- データのページング実装
- 重い処理はバックグラウンドジョブとして実行
- キャッシュ戦略の導入（Redis等の検討）
- データのダウンサンプリングによる表示の最適化

### 5.2 互換性の問題

**課題:**
- 既存のデータ形式との互換性維持

**対応策:**
- データ移行ツールの開発
- 古いデータ形式のインポートサポート
- バージョン情報の付加

### 5.3 アルゴリズムの再最適化

**課題:**
- バックエンド環境に最適化されたアルゴリズムへの移行

**対応策:**
- パフォーマンステストの実施
- 非同期処理を活用した最適化
- マルチスレッド/プロセス処理の導入
- クラウド環境向けのスケーリング戦略

## 6. 次のステップ

1. **バックエンド開発**:
   - FastAPIプロジェクトの基本構造の実装
   - コアロジック（風向風速推定）の移行
   - データベーススキーマの実装

2. **フロントエンド開発**:
   - Next.jsプロジェクトのセットアップ
   - 基本UIコンポーネントの実装
   - APIとの連携

3. **認証・権限システム**:
   - Supabaseの認証機能の統合
   - ユーザー権限管理の実装

4. **データ永続化**:
   - データベースマイグレーション
   - データクエリ最適化
