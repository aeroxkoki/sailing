# セーリング戦略分析システム - アーキテクチャ概要

## 1. はじめに

本ドキュメントでは、セーリング戦略分析システムの新アーキテクチャの概要について説明します。このシステムは、GPSデータを活用してセーリング競技者の戦略的判断をサポートし、風向風速パターンの分析や戦略ポイントの検出を行うためのツールです。

既存のStreamlit/Pythonベースのプロトタイプから、より拡張性が高く、ユーザー体験に優れたシステムへの移行を計画しています。新アーキテクチャは、フロントエンド（Next.js）、バックエンド（FastAPI）、データベース（Supabase）の3層構造を採用します。

## 2. アーキテクチャ原則

新アーキテクチャは以下の原則に基づいて設計されています：

- **関心の分離**: フロントエンド、バックエンド、データベースの明確な分離
- **RESTful設計**: 標準的なHTTPメソッドとJSONベースの通信
- **スケーラビリティ**: 並列処理と非同期処理によるパフォーマンス最適化
- **モジュール性**: 独立したコンポーネントによる開発と維持の容易さ
- **セキュリティ**: 認証・認可による適切なアクセス制御
- **拡張性**: 将来の機能追加に対応できる柔軟な設計

## 3. システム構成

### 3.1 全体構成図

```
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│   フロントエンド   │      │   バックエンド    │      │   データストア    │
│    (Next.js)    │<---->│    (FastAPI)    │<---->│   (Supabase)    │
└─────────────────┘      └─────────────────┘      └─────────────────┘
        ↑                        ↑                         ↑
        │                        │                         │
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│    ユーザー     │      │  外部データソース  │      │    ストレージ     │
│  (ブラウザ)     │      │  (GPXファイル等)  │      │  (ファイル保存)   │
└─────────────────┘      └─────────────────┘      └─────────────────┘
```

### 3.2 技術スタック

#### フロントエンド
- **フレームワーク**: Next.js 14+
- **UI**: React 18+
- **状態管理**: React Context + SWR
- **スタイリング**: CSS Modules / Tailwind CSS
- **マップ表示**: Mapbox GL JS / React Map GL
- **データ可視化**: Recharts

#### バックエンド
- **フレームワーク**: FastAPI 0.104+
- **認証**: JWT / Supabase Auth
- **タスク処理**: Background Tasks
- **バリデーション**: Pydantic 2.4+
- **API文書**: OpenAPI (Swagger)

#### データベース
- **RDBMS**: PostgreSQL (Supabase)
- **ORM**: SQLAlchemy / Supabase Client
- **マイグレーション**: Alembic
- **キャッシュ**: Redis (オプション)

#### デプロイメント
- **フロントエンド**: Vercel
- **バックエンド**: Render
- **データベース**: Supabase
- **CI/CD**: GitHub Actions

## 4. コンポーネント詳細

### 4.1 フロントエンド

フロントエンドはNext.jsを使用し、以下の主要コンポーネントで構成されます：

- **ページコンポーネント**: ルーティングとレイアウト
  - ダッシュボード
  - セッション管理
  - データ分析
  - レポート生成

- **機能コンポーネント**: 
  - マップビュー（軌跡表示、風向風速表示）
  - タイムラインコントロール
  - データチャート
  - ファイルインポート

- **共通コンポーネント**:
  - ナビゲーション
  - 認証フォーム
  - アラート/通知
  - データローダー

### 4.2 バックエンド

バックエンドはFastAPIを使用し、以下のレイヤーで構成されます：

- **APIレイヤー**: エンドポイント定義とリクエスト処理
  - ルーティング
  - パラメータ検証
  - レスポンス生成

- **サービスレイヤー**: ビジネスロジックの実装
  - データインポート/エクスポート
  - 風向風速推定
  - 戦略検出
  - レポート生成

- **データアクセスレイヤー**: データの取得と保存
  - リポジトリパターン
  - キャッシュ管理
  - トランザクション制御

- **ドメインモデル**: システムのコアエンティティ
  - Pydanticモデル
  - ドメインオブジェクト
  - 値オブジェクト

### 4.3 データベース

データベースはSupabase（PostgreSQL）を使用し、以下のスキーマで構成されます：

- **認証**: ユーザー管理とセッション管理
  - users
  - user_preferences

- **セッションデータ**: セーリングセッション情報
  - sessions
  - tracks
  - track_points (パーティショニング)

- **分析データ**: 分析結果と推定データ
  - wind_data
  - wind_fields
  - strategy_points
  - analysis_tasks

- **レポート**: 生成されたレポート情報
  - reports
  - templates

## 5. 主要機能フロー

### 5.1 データインポートフロー

1. ユーザーがGPXファイルをアップロード
2. フロントエンドがファイルをバックエンドにPOSTリクエスト
3. バックエンドがファイルを解析してトラックデータを抽出
4. データベースにセッション、トラック、トラックポイントを保存
5. バックエンドが処理結果をフロントエンドに返却
6. フロントエンドが結果を表示し、マップビューを更新

### 5.2 風向風速推定フロー

1. ユーザーが風向風速推定をリクエスト
2. バックエンドが非同期タスクを作成
3. バックグラウンドタスクがトラックデータから風向風速を推定
4. 推定結果をデータベースに保存
5. フロントエンドがポーリングで処理状況を確認
6. 処理完了後、フロントエンドが結果を取得して表示

### 5.3 戦略検出フロー

1. ユーザーが戦略検出をリクエスト
2. バックエンドが風向風速データとトラックデータを取得
3. 戦略検出アルゴリズムが実行され、重要ポイントを検出
4. 検出結果をデータベースに保存
5. フロントエンドがポーリングで処理状況を確認
6. 処理完了後、フロントエンドがマップ上に戦略ポイントを表示

## 6. 非機能要件

### 6.1 パフォーマンス

- **レスポンス時間**: 一般的なAPIリクエストは500ms以内
- **スケーラビリティ**: 同時接続100ユーザーに対応
- **処理能力**: 50,000点のGPSデータを10秒以内に処理

### 6.2 セキュリティ

- **認証**: JWTベースのトークン認証
- **認可**: ロールベースのアクセス制御
- **データ保護**: 転送中と保存時の暗号化
- **API保護**: レート制限とCSRF対策

### 6.3 可用性

- **稼働率**: 99.9%（メンテナンス時間を除く）
- **バックアップ**: 日次バックアップ
- **障害復旧**: RPO 24時間、RTO 4時間

### 6.4 拡張性

- **水平スケール**: 負荷に応じたインスタンス追加
- **機能拡張**: プラグイン方式でのカスタム分析機能
- **マルチデバイス**: レスポンシブデザインによるモバイル対応

## 7. デプロイメント

### 7.1 開発環境

- **ローカル開発**: Docker Compose
- **開発ワークフロー**: Feature Branch + Pull Request
- **CI/CD**: GitHub Actions

### 7.2 本番環境

- **フロントエンド**: Vercel（オートデプロイ）
- **バックエンド**: Render（CD連携）
- **データベース**: Supabase（マネージドサービス）

### 7.3 テスト環境

- **単体テスト**: pytest / Jest
- **統合テスト**: FastAPI TestClient / React Testing Library
- **E2Eテスト**: Playwright

## 8. 移行戦略

現行システムから新アーキテクチャへの移行は、以下の段階で実施します：

### 第1段階: 基盤構築（準備フェーズ）
- リポジトリ構造の再編成
- サービスアカウントの作成と連携
- 既存コードの分析とモジュール分割

### 第2段階: バックエンド開発
- FastAPIプロジェクトの構築
- データモデルの設計
- コアアルゴリズムの移植

### 第3段階: フロントエンド開発
- Next.jsプロジェクトの構築
- UIコンポーネントの実装
- APIクライアントの実装

### 第4段階: 統合とデプロイ
- バックエンドとフロントエンドの統合
- CI/CDパイプラインの構築
- 本番環境へのデプロイ

## 9. リスクと対策

### 9.1 技術的リスク

1. **大量データ処理の課題**
   - **リスク**: GPSデータが大量になると処理が遅延
   - **対策**: データのダウンサンプリング、ページング処理、非同期処理

2. **複雑な計算処理の負荷**
   - **リスク**: 風向風速推定などの計算負荷が高い
   - **対策**: バックグラウンドタスク化、キャッシュ機構の導入

3. **マルチデバイス対応の難しさ**
   - **リスク**: 様々な画面サイズでの表示最適化
   - **対策**: モバイルファーストのレスポンシブデザイン

### 9.2 プロジェクト管理リスク

1. **スキル習得の課題**
   - **リスク**: 新技術スタックの学習コスト
   - **対策**: 段階的な導入、ドキュメント整備、ペアプログラミング

2. **移行期間中の機能凍結**
   - **リスク**: 移行中の新機能追加が困難
   - **対策**: 優先度の高い機能から段階的に移行

3. **既存データの互換性**
   - **リスク**: データ構造の変更による互換性喪失
   - **対策**: データマイグレーションツールの開発

## 10. 結論

本アーキテクチャ計画により、セーリング戦略分析システムは以下の利点を得ることができます：

- **拡張性の向上**: モジュール化されたアーキテクチャによる機能拡張性
- **性能の向上**: 非同期処理と最適化されたデータベース設計
- **ユーザー体験の向上**: レスポンシブなUIと高速なインタラクション
- **保守性の向上**: 明確な責務分離と標準的な開発プラクティス

Next.js、FastAPI、Supabaseを中核とした近代的なWeb技術スタックへの移行により、将来の要件変更にも柔軟に対応できるシステムを構築することが可能になります。

## 更新履歴

- 2025-04-18: 初版作成
